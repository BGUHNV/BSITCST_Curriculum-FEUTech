<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSITCST Smart Planner & Scheduler</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--primary-color); margin-bottom: 5px; }

        /* Dashboard Stats */
        .dashboard-stats {
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;
        }
        .stat-item { text-align: center; margin: 10px; }
        .stat-value { font-size: 2em; font-weight: bold; color: var(--accent-color); display: block; }
        .stat-label { font-size: 0.9em; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin-top: 15px; height: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.5s ease-in-out; text-align: center; line-height: 20px; color: white; font-size: 0.8em; }

        /* --- DRAG AND DROP PLANNER STYLES --- */
        .planner-section {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            height: 650px; /* Increased height for controls */
        }

        .planner-col {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .planner-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .planner-controls {
            padding: 10px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .planner-controls select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex: 1;
            min-width: 100px;
        }

        .planner-controls button {
            padding: 5px 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .planner-controls button:hover { background: #2980b9; }

        .planner-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        .drop-zone {
            min-height: 100%;
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 10px;
            transition: background 0.3s;
        }

        .drop-zone.drag-over {
            background-color: #e3f2fd;
            border-color: var(--accent-color);
        }

        .draggable-card {
            background: white;
            border: 1px solid #ddd;
            border-left: 4px solid var(--accent-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .draggable-card:active { cursor: grabbing; }
        .draggable-card .card-units { font-weight: bold; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .draggable-card .card-pre { font-size: 0.75em; color: #888; display: block; margin-top: 4px; }
        
        .status-valid { background-color: var(--success-color); padding: 5px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-invalid { background-color: var(--danger-color); padding: 5px 10px; border-radius: 15px; font-size: 0.8em; }
        .status-warning { background-color: var(--warning-color); color: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.8em; }

        /* --- END PLANNER STYLES --- */

        /* Main Layout */
        .year-section { margin-bottom: 40px; }
        .year-title { background-color: var(--primary-color); color: white; padding: 10px 20px; border-radius: 8px 8px 0 0; margin: 0; }
        .term-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; background: #e8eef1; padding: 20px; border-radius: 0 0 8px 8px; }
        .term-card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .term-header { background-color: var(--accent-color); color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        .code-col { width: 15%; font-weight: bold; }
        .title-col { width: 45%; }
        .unit-col { width: 10%; text-align: center; font-weight: bold; color: #555; }
        .action-col { width: 30%; text-align: right; white-space: nowrap; }

        .status-passed { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        .status-locked { background-color: #e9ecef; color: #6c757d; pointer-events: none; opacity: 0.7; }

        .btn { padding: 4px 8px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 3px; }
        .btn-pass:hover, .active-pass { background: #28a745; color: white; border-color: #28a745; }
        .btn-fail:hover, .active-fail { background: #dc3545; color: white; border-color: #dc3545; }

        .controls { text-align: center; margin-bottom: 20px; }
        input[type="text"] { padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        button.reset-btn { padding: 10px 15px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* Notification */
        #notification {
            position: fixed; top: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000;
        }
    </style>
</head>
<body>

<div id="notification"></div>

<div class="container">
    <header>
        <h1>BS Information Technology</h1>
        <h3>Smart Scheduler & Planner (CST Curriculum)</h3>
    </header>

    <div class="dashboard-stats">
        <div class="stat-item"><span class="stat-value" id="totalUnitsCompleted">0</span><span class="stat-label">Units Completed</span></div>
        <div class="stat-item"><span class="stat-value" id="totalUnitsRequired">0</span><span class="stat-label">Total Required</span></div>
        <div class="stat-item"><span class="stat-value" id="completionPercentage">0%</span><span class="stat-label">Progress</span></div>
        <div class="progress-container"><div class="progress-bar" id="overallProgressBar">0%</div></div>
    </div>

    <div class="planner-section">
        <div class="planner-col">
            <div class="planner-header">
                <span>Available Courses</span>
                <small style="font-weight: normal; opacity: 0.8;">Drag manually if needed</small>
            </div>
            <div class="planner-body">
                <input type="text" id="plannerSearch" placeholder="Filter subjects..." style="width: 90%; margin-bottom: 10px; padding: 8px;">
                <div id="source-zone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                    </div>
            </div>
        </div>

        <div class="planner-col">
            <div class="planner-header">
                <span>My Draft Term</span>
                <span id="planner-status" class="status-warning">0 Units</span>
            </div>
            
            <div class="planner-controls">
                <select id="selYear">
                    <option value="FIRST YEAR">First Year</option>
                    <option value="SECOND YEAR">Second Year</option>
                    <option value="THIRD YEAR">Third Year</option>
                    <option value="FOURTH YEAR">Fourth Year</option>
                </select>
                <select id="selTerm">
                    <option value="1st Term">1st Term</option>
                    <option value="2nd Term">2nd Term</option>
                    <option value="3rd Term">3rd Term</option>
                </select>
                <select id="selMaxUnits" onchange="updatePlannerStats()" style="max-width: 100px; font-weight: bold;">
                    <option value="21">Max 21</option>
                    <option value="22">Max 22</option>
                </select>
                <button onclick="loadTermTemplate()">Load</button>
            </div>

            <div class="planner-body">
                <div id="target-zone" class="drop-zone" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <p style="text-align: center; color: #aaa; pointer-events: none; margin-top: 20px;">
                        Select Year/Term above and click 'Load'<br>or Drag Courses manually
                    </p>
                </div>
            </div>
            <div id="plannerFooter" style="padding: 10px; background: #eee; text-align: center; font-size: 0.85em; color: #555;">
                Min: 12 Units | Max: 21 Units | Must pass prerequisites
            </div>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="searchBar" placeholder="Search curriculum table...">
        <button class="reset-btn" onclick="resetData()">Reset All Progress</button>
    </div>

    <div id="curriculum-root"></div>
</div>

<script>
    // --- DATA ---
    const curriculumData = [
        {
            year: "FIRST YEAR",
            terms: [
                {
                    name: "1st Term",
                    courses: [
                        { code: "CCS0003", title: "COMPUTER PROGRAMMING 1 (LEC)", units: 2, pre: [] },
                        { code: "CCS0003L", title: "COMPUTER PROGRAMMING 1 (LAB)", units: 1, pre: [] },
                        { code: "GED0004", title: "PHYSICAL EDUCATION 1", units: 3, pre: [] },
                        { code: "GED0006", title: "PERSONAL AND PROFESSIONAL EFFECTIVENESS", units: 2, pre: [] },
                        { code: "GED0009", title: "READINGS IN PHILIPPINE HISTORY", units: 3, pre: [] },
                        { code: "GED0011", title: "SCIENCE, TECHNOLOGY AND SOCIETY", units: 3, pre: [] },
                        { code: "CCS0001", title: "INTRODUCTION TO COMPUTING (LEC)", units: 2, pre: [] },
                        { code: "CCS0001L", title: "INTRODUCTION TO COMPUTING (LAB)", units: 1, pre: [] }
                    ]
                },
                {
                    name: "2nd Term",
                    courses: [
                        { code: "NSTP1", title: "CIVIC WELFARE TRAINING SERVICE 1", units: 0, pre: [] },
                        { code: "IT0002", title: "USER DESIGN FUNDAMENTALS", units: 1, pre: [] },
                        { code: "GED0085", title: "GENDER AND SOCIETY", units: 3, pre: [] },
                        { code: "GED0027", title: "MATHEMATICS IN THE MODERN WORLD", units: 3, pre: [] },
                        { code: "GED0015", title: "PHYSICAL EDUCATION 2", units: 3, pre: ["GED0004"] },
                        { code: "GED0001", title: "SPECIALIZED ENGLISH PROGRAM 1", units: 3, pre: [] },
                        { code: "CCS0007", title: "COMPUTER PROGRAMMING 2 (LEC)", units: 2, pre: ["CCS0003", "CCS0003L"] },
                        { code: "CCS0007L", title: "COMPUTER PROGRAMMING 2 (LAB)", units: 1, pre: ["CCS0003", "CCS0003L"] },
                        { code: "CCS0005", title: "INTRODUCTION TO HUMAN COMPUTER INTERACTION (LEC)", units: 2, pre: ["CCS0001", "CCS0001L"] },
                        { code: "CCS0005L", title: "INTRODUCTION TO HUMAN COMPUTER INTERACTION (LAB)", units: 1, pre: ["CCS0001", "CCS0001L"] }
                    ]
                },
                {
                    name: "3rd Term",
                    courses: [
                        { code: "CCS0015", title: "DATA STRUCTURES AND ALGORITHMS (LEC)", units: 2, pre: ["CCS0007", "CCS0007L"] },
                        { code: "CCS0015L", title: "DATA STRUCTURES AND ALGORITHMS (LAB)", units: 1, pre: ["CCS0007", "CCS0007L"] },
                        { code: "CCS0105", title: "PROFESSIONAL DEVELOPMENT (COMPUTING PROFESSION)", units: 1, pre: ["GED0006"] },
                        { code: "GED0007", title: "ART APPRECIATION", units: 3, pre: [] },
                        { code: "GED0023", title: "PHYSICAL EDUCATION 3", units: 3, pre: ["GED0015"] },
                        { code: "GED0035", title: "THE CONTEMPORARY WORLD", units: 3, pre: [] },
                        { code: "GED0039", title: "APPLIED STATISTICS", units: 3, pre: ["GED0027"] },
                        { code: "IT0004", title: "USER EXPERIENCE DESIGN FUNDAMENTALS", units: 1, pre: ["IT0002"] },
                        { code: "NSTP2", title: "CIVIC WELFARE TRAINING SERVICE 2", units: 0, pre: ["NSTP1"] },
                        { code: "IT0043", title: "WEB DESIGN WITH CLIENT SIDE SCRIPTING", units: 2, pre: ["CCS0005", "CCS0005L"] },
                        { code: "IT0043L", title: "WEB DESIGN WITH CLIENT SIDE SCRIPTING (LAB)", units: 1, pre: ["CCS0005", "CCS0005L"] }
                    ]
                }
            ]
        },
        {
            year: "SECOND YEAR",
            terms: [
                {
                    name: "1st Term",
                    courses: [
                        { code: "IT0017", title: "DISCRETE MATHEMATICS", units: 3, pre: ["GED0027"] },
                        { code: "CCS0023", title: "OBJECT ORIENTED PROGRAMMING (LEC)", units: 2, pre: ["CCS0007", "CCS0007L"] },
                        { code: "CCS0023L", title: "OBJECT ORIENTED PROGRAMMING (LAB)", units: 1, pre: ["CCS0007", "CCS0007L"] },
                        { code: "GED0019", title: "UNDERSTANDING THE SELF", units: 3, pre: [] },
                        { code: "GED0021", title: "SPECIALIZED ENGLISH PROGRAM 2", units: 3, pre: ["GED0001"] },
                        { code: "IT0019", title: "QUANTITATIVE METHODS (INCL MODELING AND SIMULATION)", units: 3, pre: ["GED0039"] },
                        { code: "IT0051", title: "IT ELECTIVE - HUMAN COMPUTER INTERACTION 2", units: 3, pre: ["CCS0005", "CCS0005L"] },
                        { code: "IT0119", title: "INFORMATION MANAGEMENT", units: 2, pre: ["CCS0015", "CCS0015L"] },
                        { code: "IT0119L", title: "INFORMATION MANAGEMENT (LAB)", units: 1, pre: ["CCS0015", "CCS0015L"] }
                    ]
                },
                {
                    name: "2nd Term",
                    courses: [
                        { code: "IT0009", title: "FUNDAMENTALS OF DATABASE SYSTEMS", units: 3, pre: ["IT0119", "IT0119L"] },
                        { code: "IT0201", title: "IT SPECIALIZATION 4 - INTRODUCTION TO CYBERSECURITY AND CYBERSECURITY ESSENTIALS", units: 3, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0200", title: "IT SPECIALIZATION 6- Digital Forensics Essentials", units: 3, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0013", title: "NETWORKING 1", units: 3, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0011", title: "INTEGRATIVE PROGRAMMING AND TECHNOLOGIES", units: 3, pre: ["CCS0023", "CCS0023L"] },
                        { code: "CCS0101", title: "DESIGN THINKING (CCS)", units: 3, pre: ["CCS0005", "CCS0005L"] }
                    ]
                },
                {
                    name: "3rd Term",
                    courses: [
                        { code: "GED0081", title: "COLLEGE PHYSICS 1 LECTURE", units: 2, pre: ["GED0011"] },
                        { code: "GED0081L", title: "COLLEGE PHYSICS 1 LABORATORY", units: 1, pre: ["GED0011"] },
                        { code: "GED0031", title: "PURPOSIVE COMMUNICATION", units: 3, pre: ["GED0021"] },
                        { code: "CCS0103", title: "TECHNOPRENEURSHIP (CCS)", units: 3, pre: ["CCS0101"] },
                        { code: "CCS0043", title: "APPLICATIONS DEVELOPMENT AND EMERGING TECHNOLOGIES (LEC)", units: 2, pre: ["IT0119", "IT0119L", "IT0043", "IT0043L"] },
                        { code: "CCS0043L", title: "APPLICATIONS DEVELOPMENT AND EMERGING TECHNOLOGIES (LAB)", units: 1, pre: ["IT0119", "IT0119L", "IT0043", "IT0043L"] },
                        { code: "IT0203", title: "IT SPECIALIZATION 6- Digital Forensics Essentials", units: 3, pre: ["IT0200"] }, 
                        { code: "IT0202", title: "IT SPECIALIZATION 5 - ETHICAL HACKING ESSENTIALS", units: 3, pre: ["IT0200", "IT0201"] }
                    ]
                }
            ]
        },
        {
            year: "THIRD YEAR",
            terms: [
                {
                    name: "1st Term",
                    courses: [
                        { code: "IT0035", title: "APPLIED OPERATING SYSTEM", units: 2, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0035L", title: "APPLIED OPERATING SYSTEM LAB", units: 1, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0037", title: "SYSTEM ANALYSIS AND DESIGN", units: 3, pre: ["CCS0043", "CCS0043L", "CCS0103", "IT0202"] },
                        { code: "IT0049", title: "IT ELECTIVE - WEB SYSTEM TECHNOLOGIES", units: 3, pre: ["CCS0043", "CCS0043L"] },
                        { code: "IT0204", title: "IT SPECIALIZATION 7 - CYBERSECURITY AND PRIVACY: LAWS, POLICIES, AND COMPLIANCE", units: 3, pre: ["IT0202"] },
                        { code: "IT0015", title: "NETWORKING 2", units: 3, pre: ["IT0013"] },
                        { code: "GED0083", title: "COLLEGE PHYSICS 2 LECTURE", units: 2, pre: ["GED0081", "GED0081L"] },
                        { code: "GED0083L", title: "COLLEGE PHYSICS 2 LABORATORY", units: 1, pre: ["GED0081", "GED0081L"] }
                    ]
                },
                {
                    name: "2nd Term",
                    courses: [
                        { code: "IT0023", title: "SYSTEM INTEGRATION AND ARCHITECTURE 1", units: 3, pre: ["IT0037"] },
                        { code: "IT0205", title: "IT SPECIALIZATION 9 - CLOUD SECURITY", units: 3, pre: ["IT0103"] },
                        { code: "IT0103", title: "IT SPECIALIZATION 8 - NETWORKING 3", units: 3, pre: ["IT0015"] },
                        { code: "IT0047", title: "IT ELECTIVE - COMPUTER SYSTEMS AND PLATFORM TECHNOLOGIES", units: 3, pre: ["CCS0001", "CCS0001L"] },
                        { code: "IT0041", title: "E-COMMERCE WITH DIGITAL MARKETING", units: 3, pre: ["CCS0043", "CCS0043L", "CCS0103"] },
                        { code: "IT0039", title: "IT PROJECT MANAGEMENT", units: 3, pre: ["IT0037", "IT0203"] }
                    ]
                },
                {
                    name: "3rd Term",
                    courses: [
                        { code: "IT0207", title: "CAPSTONE PROJECT 1 (CST)", units: 3, pre: ["IT0039", "IT0023"] },
                        { code: "IT0125", title: "INFORMATION ASSURANCE & SECURITY 1", units: 3, pre: ["IT0015"] },
                        { code: "IT0021", title: "SYSTEM ADMINISTRATION AND MAINTENANCE", units: 3, pre: ["IT0023"] },
                        { code: "GED0061", title: "ETHICS", units: 3, pre: ["CCS0105"] },
                        { code: "GED0049", title: "LIFE AND WORKS OF RIZAL", units: 3, pre: [] },
                        { code: "GED0043", title: "SPECIALIZED ENGLISH PROGRAM 3", units: 3, pre: [] }
                    ]
                }
            ]
        },
        {
            year: "FOURTH YEAR",
            terms: [
                {
                    name: "1st Term",
                    courses: [
                        { code: "IT0025", title: "SOCIAL AND PROFESSIONAL ISSUES", units: 3, pre: ["GED0006"] },
                        { code: "GED0047", title: "FOREIGN LANGUAGE", units: 3, pre: [] },
                        { code: "GED0073", title: "GE ELECTIVE 2", units: 3, pre: [] },
                        { code: "IT0007", title: "INFORMATION ASSURANCE AND SECURITY 2", units: 3, pre: ["IT0125"] },
                        { code: "IT0053", title: "IT ELECTIVE - EMERGING TECHNOLOGIES IN COMPUTING", units: 1, pre: ["CCS0043", "CCS0043L"] },
                        { code: "IT0057", title: "IT ELECTIVE 6 - CERTIFICATION EXAM", units: 0, pre: ["IT0027"] },
                        { code: "IT0129", title: "IT ELECTIVE - SYSTEM INTEGRATION & ARCHITECTURE 2", units: 3, pre: ["IT0023"] },
                        { code: "IT0209", title: "CAPSTONE PROJECT 2 (CST)", units: 3, pre: ["IT0207"] }
                    ]
                },
                {
                    name: "2nd Term",
                    courses: [
                        { code: "IT0031", title: "INTERNSHIP 1", units: 9, pre: ["IT0025", "IT0209"] }
                    ]
                },
                {
                    name: "3rd Term",
                    courses: [
                        { code: "IT0033", title: "INTERNSHIP 2 (520 HOURS)", units: 9, pre: ["IT0031"] }
                    ]
                }
            ]
        }
    ];

    let courseStatus = JSON.parse(localStorage.getItem('bsit_smart_tracker_v3')) || {};
    const root = document.getElementById('curriculum-root');
    const searchBar = document.getElementById('searchBar');
     
    // Planner Elements
    const sourceZone = document.getElementById('source-zone');
    const targetZone = document.getElementById('target-zone');
    const plannerStatus = document.getElementById('planner-status');
    const plannerSearch = document.getElementById('plannerSearch');
    const selYear = document.getElementById('selYear');
    const selTerm = document.getElementById('selTerm');
    const selMaxUnits = document.getElementById('selMaxUnits'); // New Selector
    const plannerFooter = document.getElementById('plannerFooter'); // Footer text

    // Stats Elements
    const elTotalUnitsCompleted = document.getElementById('totalUnitsCompleted');
    const elTotalUnitsRequired = document.getElementById('totalUnitsRequired');
    const elCompletionPercentage = document.getElementById('completionPercentage');
    const elOverallProgressBar = document.getElementById('overallProgressBar');

    // --- UTILS ---
    function saveState() {
        localStorage.setItem('bsit_smart_tracker_v3', JSON.stringify(courseStatus));
        renderCurriculum(searchBar.value);
        renderPlannerSource(); 
        resetPlannerTarget(); 
    }
     
    function resetData() {
        if(confirm("Reset all data?")) { courseStatus = {}; saveState(); }
    }
     
    function setStatus(code, status) {
        if (courseStatus[code] === status) { delete courseStatus[code]; } else { courseStatus[code] = status; }
        saveState();
    }

    function showNotification(msg, type = 'error') {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.background = type === 'error' ? '#dc3545' : '#28a745';
        notif.style.opacity = '1';
        setTimeout(() => { notif.style.opacity = '0'; }, 3000);
    }

    // --- HELPER: Get Course Object by Code ---
    function getCourseByCode(code) {
        for (const y of curriculumData) {
            for (const t of y.terms) {
                const found = t.courses.find(c => c.code === code);
                if (found) return found;
            }
        }
        return null;
    }

    // --- NEW FUNCTION: Load Standard Term ---
    function loadTermTemplate() {
        // 1. Reset current draft
        resetPlannerTarget(false); // false = don't reset source yet

        const selectedYear = selYear.value;
        const selectedTerm = selTerm.value;

        // 2. Find the term in data
        const yearObj = curriculumData.find(y => y.year === selectedYear);
        if (!yearObj) return;
        const termObj = yearObj.terms.find(t => t.name === selectedTerm);
        if (!termObj) {
            showNotification("Term not found or empty.");
            return;
        }

        let addedCount = 0;
        let blockedCount = 0;

        // 3. Iterate through original courses
        termObj.courses.forEach(c => {
            // Check if already passed
            if (courseStatus[c.code] === 'passed') {
                return; // Skip passed courses
            }

            // Check prerequisites
            const failedPrereqs = c.pre.filter(p => courseStatus[p] !== 'passed');
            if (failedPrereqs.length > 0) {
                blockedCount++;
                return; // Skip locked courses
            }

            // Check if already in draft (should be empty, but safety check)
            if (document.getElementById(`card-${c.code}-target`)) return;

            // Add to draft
            const originalCard = document.getElementById(`card-${c.code}`);
            if (originalCard) {
                targetZone.appendChild(originalCard);
                addedCount++;
            }
        });

        updatePlannerStats();
        
        let msg = `Loaded ${addedCount} courses for ${selectedTerm}.`;
        if (blockedCount > 0) msg += ` (${blockedCount} skipped due to prereqs)`;
        showNotification(msg, addedCount > 0 ? 'success' : 'error');
    }

    // --- RECURSIVE LOCK CHECK (For Table View) ---
    function isLockedRecursive(courseCode, visited = new Set()) {
        if (visited.has(courseCode)) return false;
        visited.add(courseCode);

        let courseObj = getCourseByCode(courseCode);
        if (!courseObj) return false;

        for (let p of courseObj.pre) {
            if (courseStatus[p] === 'failed') return true; 
            if (isLockedRecursive(p, visited)) return true;
        }
        return false;
    }

    // --- DRAG AND DROP LOGIC ---

    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }
     
    // Remove drag-over style when leaving
    sourceZone.addEventListener('dragleave', () => sourceZone.classList.remove('drag-over'));
    targetZone.addEventListener('dragleave', () => targetZone.classList.remove('drag-over'));

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
        ev.dataTransfer.effectAllowed = "move";
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');
        
        var data = ev.dataTransfer.getData("text");
        var draggedElement = document.getElementById(data);
        if(!draggedElement) return;

        const courseCode = draggedElement.getAttribute('data-code');
        const courseObj = getCourseByCode(courseCode);
        const targetId = ev.currentTarget.id;

        // Logic for dropping into TARGET (My Draft)
        if (targetId === 'target-zone') {
            
            // 1. Check Prerequisites
            const failedPrereqs = courseObj.pre.filter(p => courseStatus[p] !== 'passed');
            if (failedPrereqs.length > 0) {
                showNotification(`Cannot add ${courseCode}. Missing prerequisites: ${failedPrereqs.join(', ')}`);
                return; // Block drop
            }

            // 2. Check Max Units (Dynamic based on select)
            const maxUnits = parseInt(selMaxUnits.value);
            const currentUnits = calculatePlannerUnits();
            if (currentUnits + courseObj.units > maxUnits) {
                showNotification(`Cannot add ${courseCode}. Max ${maxUnits} units allowed.`, 'error');
                return; // Block drop
            }

            // If Valid:
            targetZone.appendChild(draggedElement);
            updatePlannerStats();
        } 
        // Logic for dropping back to SOURCE (Available)
        else if (targetId === 'source-zone') {
            sourceZone.appendChild(draggedElement);
            updatePlannerStats();
        }
    }

    function calculatePlannerUnits() {
        let total = 0;
        const cards = targetZone.querySelectorAll('.draggable-card');
        cards.forEach(card => {
            total += parseInt(card.getAttribute('data-units'));
        });
        return total;
    }

    function updatePlannerStats() {
        const units = calculatePlannerUnits();
        const maxUnits = parseInt(selMaxUnits.value);

        plannerStatus.textContent = `${units} Units`;
        
        // Update Footer text
        plannerFooter.textContent = `Min: 12 Units | Max: ${maxUnits} Units | Must pass prerequisites`;

        if (units < 12) {
            plannerStatus.className = 'status-warning';
            plannerStatus.textContent += " (Underload)";
        } else if (units > maxUnits) {
            plannerStatus.className = 'status-invalid';
            plannerStatus.textContent += " (Overload)";
        } else {
            plannerStatus.className = 'status-valid';
            plannerStatus.textContent += " (Valid)";
        }

        // Remove placeholder text if items exist
        const placeholder = targetZone.querySelector('p');
        if (targetZone.children.length > (placeholder ? 1 : 0)) {
            if(placeholder) placeholder.style.display = 'none';
        } else {
            if(placeholder) placeholder.style.display = 'block';
        }
    }

    function resetPlannerTarget(resetSource = true) {
        // Move all items from target back to source
        const cards = Array.from(targetZone.querySelectorAll('.draggable-card'));
        cards.forEach(c => sourceZone.appendChild(c));
        updatePlannerStats();
        // Re-sort source if requested
        if(resetSource) renderPlannerSource();
    }

    // --- RENDER PLANNER SOURCE ---
    function renderPlannerSource() {
        const filter = plannerSearch.value.toLowerCase();
        sourceZone.innerHTML = ''; // Clear source

        // Gather all pending courses
        let pendingCourses = [];
        curriculumData.forEach(y => y.terms.forEach(t => t.courses.forEach(c => {
            if (courseStatus[c.code] !== 'passed') {
                pendingCourses.push(c);
            }
        })));

        // Create draggable cards
        pendingCourses.forEach(c => {
            // If it's already in the target zone, don't re-render in source
            const existingInTarget = document.querySelector(`#target-zone #card-${c.code}`);
            if (existingInTarget) return;

            if (c.code.toLowerCase().includes(filter) || c.title.toLowerCase().includes(filter)) {
                const card = document.createElement('div');
                card.id = `card-${c.code}`;
                card.className = 'draggable-card';
                card.setAttribute('draggable', 'true');
                card.setAttribute('data-code', c.code);
                card.setAttribute('data-units', c.units);
                card.ondragstart = drag;

                // Pre-check prereqs for visual aid
                const failedPrereqs = c.pre.filter(p => courseStatus[p] !== 'passed');
                const isLocked = failedPrereqs.length > 0;
                
                let html = `
                    <div>
                        <strong>${c.code}</strong><br>
                        <span style="font-size:0.85em">${c.title}</span>
                `;
                
                if (isLocked) {
                    html += `<span class="card-pre" style="color:#dc3545">Missing: ${failedPrereqs.join(', ')}</span>`;
                    card.style.opacity = '0.6';
                    card.style.borderLeftColor = '#dc3545';
                } else if (c.pre.length > 0) {
                      html += `<span class="card-pre">Pre: ${c.pre.join(', ')}</span>`;
                }

                html += `</div><span class="card-units">${c.units}u</span>`;
                
                card.innerHTML = html;
                sourceZone.appendChild(card);
            }
        });
    }

    plannerSearch.addEventListener('input', renderPlannerSource);


    // --- RENDER MAIN UI (CURRICULUM TABLE) ---
    function renderCurriculum(filterText = '') {
        root.innerHTML = '';
        
        // Stats Calc
        let totalUnits = 0;
        let completedUnits = 0;
        curriculumData.forEach(y => y.terms.forEach(t => t.courses.forEach(c => {
            totalUnits += c.units;
            if (courseStatus[c.code] === 'passed') completedUnits += c.units;
        })));
        elTotalUnitsCompleted.textContent = completedUnits;
        elTotalUnitsRequired.textContent = totalUnits;
        let percentage = totalUnits > 0 ? Math.round((completedUnits / totalUnits) * 100) : 0;
        elCompletionPercentage.textContent = percentage + "%";
        elOverallProgressBar.style.width = percentage + "%";
        elOverallProgressBar.textContent = percentage + "%";

        const lowerFilter = filterText.toLowerCase();

        curriculumData.forEach(yearData => {
            const yearSection = document.createElement('div');
            yearSection.className = 'year-section';
            
            const yearTitle = document.createElement('h2');
            yearTitle.className = 'year-title';
            yearTitle.textContent = yearData.year;
            yearSection.appendChild(yearTitle);

            const termContainer = document.createElement('div');
            termContainer.className = 'term-container';
            let hasVisibleCourses = false;

            yearData.terms.forEach(term => {
                const filteredCourses = term.courses.filter(c => 
                    c.code.toLowerCase().includes(lowerFilter) || 
                    c.title.toLowerCase().includes(lowerFilter)
                );

                if (filteredCourses.length > 0) {
                    hasVisibleCourses = true;
                    const termCard = document.createElement('div');
                    termCard.className = 'term-card';
                    
                    const termTotal = filteredCourses.reduce((sum, c) => sum + c.units, 0);
                    const termCompleted = filteredCourses.reduce((sum, c) => 
                        courseStatus[c.code] === 'passed' ? sum + c.units : sum
                    );

                    termCard.innerHTML = `<div class="term-header"><span>${term.name}</span><span style="font-size:0.8em;">${termCompleted}/${termTotal} units</span></div>`;

                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th class="code-col">Code</th><th class="title-col">Title</th><th class="unit-col">Units</th><th class="action-col">Actions</th></tr></thead><tbody></tbody>`;
                    const tbody = table.querySelector('tbody');

                    filteredCourses.forEach(c => {
                        const status = courseStatus[c.code];
                        const locked = isLockedRecursive(c.code);
                        const tr = document.createElement('tr');
                        
                        if (status === 'passed') tr.className = 'status-passed';
                        if (status === 'failed') tr.className = 'status-failed';
                        if (locked) tr.className = 'status-locked';

                        let buttons = `
                             <button class="btn btn-pass ${status === 'passed' ? 'active-pass' : ''}" 
                                onclick="setStatus('${c.code}', 'passed')">Pass</button>
                            <button class="btn btn-fail ${status === 'failed' ? 'active-fail' : ''}" 
                                onclick="setStatus('${c.code}', 'failed')">Fail</button>
                        `;

                        if (locked) buttons = `<span style="font-size:0.8em; color:#666;">Locked (Prereq)</span>`;

                        tr.innerHTML = `<td class="code-col">${c.code}</td><td class="title-col">${c.title}</td><td class="unit-col">${c.units}</td><td class="action-col">${buttons}</td>`;
                        tbody.appendChild(tr);
                    });
                    termCard.appendChild(table);
                    termContainer.appendChild(termCard);
                }
            });

            yearSection.appendChild(termContainer);
            if (hasVisibleCourses) root.appendChild(yearSection);
        });

        if (root.innerHTML === '') root.innerHTML = '<div style="text-align:center; padding: 20px;">No courses found.</div>';
    }

    // Initial Render
    renderCurriculum();
    renderPlannerSource();
    searchBar.addEventListener('input', (e) => renderCurriculum(e.target.value));

</script>
</body>
</html>